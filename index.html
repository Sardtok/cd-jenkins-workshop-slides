<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>CD Jenkins Workshop</title>

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/black.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>

    <style type="text/css">
        p {
            text-align: left;
        }
    </style>

</head>
<body>
<div class="reveal">
    <div class="slides">
        <section id="cover">
            <h1>Continuous Delivery Workshop</h1>
            <h2>Pipeline as Code with Jenkins</h2>
            <hr/>
            <h4>Michael Gfeller</h4>
            <h4><a href="www.computas.com">Computas AS</a></h4>
            <h4><a href="www.mgfeller.net">www.mgfeller.net</a></h4>
        </section>
        <section id="objectives">
            <h2>Objectives</h2>
            <ul>
                <li>Improved understanding of and knowledge about Continuous Integration, Delivery, and Deployment</li>
                <li>Describe the pipeline concept</li>
                <li>Understand CD stack components and roles.</li>
                <li>Application Architecture requirements for CD (i.e. parallel tests etc).</li>
            </ul>
        </section>
        <section id="prerequisites">
            <h2>Prerequisites</h2>
            <ul>
                <li>Bring your own PC</li>
                <li>Some programming experience</li>
                <li>Interest in DevOps</li>
                <li>Active participation</li>
                <li>Basic linux command line knowledge</li>
            </ul>
        </section>
        <section id="outline">
            <h2>Outline</h2>
            <ul>
                <li>Some theory about Continuous Delivery and friends.</li>
                <li>Setting up the environment.</li>
                <li>Implementing a simple pipeline for a given project.</li>
                <li>Adding new code with test first.</li>
                <li>Theory and practice</li>
            </ul>
        </section>
        <section id="ci-cd">
            <section>
                <h2>Continuous Delivery</h2>
                <img alt="Continuous Delivery. Reliable Software Releases Through Build, Test, and Deployment Automation"
                     src="cd-humble-farley-379x500.jpg" width="379" height="500"/>
            </section>
            <section>
                <h2>Continuous ...</h2>
                <ul>
                    <li class="fragment"><strong>Integration</strong>
                        <div>
                            <label class="fragment">Every commit is built, tested, packaged and deployed to
                                test.</label>
                        </div>
                    </li>
                    <li class="fragment"><strong>Delivery</strong>
                        <div>
                            <label class="fragment">Every commit <label class="fragment grow highlight-current-green">can
                                be</label> deployed to production.</label>
                        </div>
                    </li>
                    <li class="fragment"><strong>Deployment</strong>
                        <div>
                            <label class="fragment">Every commit <label
                                    class="fragment grow highlight-current-green">is</label> deployed to
                                production.</label>
                        </div>
                    </li>
                </ul>
            </section>
            <section>
                <img alt="Release It! Design and Deploy Production-Ready Software" src="release-it-417x500.jpg"
                     width="417" height="500"/>
                <aside class="notes">
                    <ul>Design and architecture need to support CD.</ul>
                </aside>
            </section>
        </section>
        <section id="environment">
            <section>
                <h2>Workshop Environment</h2>
                <ul>
                    <li>VirtualBox with server environment</li>
                    <li>VirtualBox as Vagrant project, with Puppet</li>
                    <li>Server: Ubuntu server w/o desktop</li>
                    <li>Server stack: Jenkins, Artifactory, Maven, Java, Git</li>
                    <li>Server tools: Vim (spf13-vim), ftp client</li>
                    <li>Sample project: Spring Boot application with Maven</li>
                    <li>Development environment locally: IDE, Git client, Java 8, Maven</li>
                </ul>
                <aside class="notes">
                    <ul>
                        <li>Development Environment: as we work with simple code, we can also just use the environment
                            on the vbox, with nano and vim.
                        </li>
                    </ul>
                </aside>
            </section>
            <section>
                <h2>Get Started!</h2>
                <p>These slides use <a href="http://lab.hakim.se/reveal-js/#/">reveal.js</a></p>
                <p>Clone them from <a href="https://github.com/mgfeller/cd-jenkins-workshop-slides">https://github.com/mgfeller/cd-jenkins-workshop-slides</a>.
                </p>
                <p>Setup the server environment: follow the instructions (do not configure Jenkins and Artifactory yet)
                    in the <a href="https://github.com/mgfeller/cd-jenkins-workshop/blob/master/README.md">readme</a> on
                    <a href="https://github.com/mgfeller/cd-jenkins-workshop">https://github.com/mgfeller/cd-jenkins-workshop</a>.
                </p>
                <aside class="notes">
                    <ul>
                        <li>vagrant reload --provision</li>
                        <li>VirtualBox Guest Additions commented out by default</li>
                    </ul>
                </aside>
            </section>
        </section>
        <section>
            <section>
                <h1>Setup Jenkins</h1>
            </section>
            <section>
                <h2>Unlock Jenkins</h2>
                <ul>
                    <li>In browser, open <a href="http://192.168.33.10:8080/">http://192.168.33.10:8080/</a>
                    </li>
                    <li>On command line, open ssh-shell:<br/>
                        <em>ssh vagrant@192.168.33.10</em>, password:
                        <em>vagrant</em><br/> (or run
                        <em>vagrant ssh</em> in the project folder)
                    </li>
                    <li>Run <em>sudo cat /var/lib/jenkins/secrets/initialAdminPassword</em> and copy this
                        administrator password into the field in the browser
                    </li>
                </ul>
                <img src="unlock-jenkins-194x200.jpg" alt="Unlock Jenkins" width="194" height="200">
            </section>
            <section>
                <h2>Suggested Plugins</h2>
                <img alt="Install Suggested Jenkins Plugins" src="customize-jenkins-install-plugins-493x400.jpg"
                     height="400" width="493"/>
            </section>
            <section>
                <h2>First Admin User</h2>
                <ul>
                    <li>Username: admin</li>
                    <li>Password: 1234!abcd</li>
                    <li>Full name: Admin</li>
                    <li>E-mail address: vagrant@localhost</li>
                </ul>
            </section>
            <section>
                <h2>Jenkins Location</h2>
                <ul>
                    <li><a href="http://192.168.33.10:8080/configure">Jenkins > Manage Jenkins > Configure System</a>
                    </li>
                    <li>Go to 'Jenkins Location'</li>
                    <li>Jenkins URL: http://192.168.33.10:8080/</li>
                    <li>System Admin e-mail address: vagrant@localhost</li>
                </ul>
            </section>
            <section>
                <h2>Jenkins E-mail Notification</h2>
                <ul>
                    <li><a href="http://192.168.33.10:8080/configure">Jenkins > Manage Jenkins > Configure System</a>
                    </li>
                    <li>Go to 'E-mail Notification'</li>
                    <li>SMTP server: localhost</li>
                    <li>Default user e-mail suffix: @localhost</li>
                    <li>Send test e-mail to: vagrant@localhost</li>
                    <li>Verify in ssh-shell by running <em>mail</em>.</li>
                </ul>
            </section>
            <section>
                <h2>Jenkins Global Tool Java</h2>
                <ul>
                    <li><a href="http://192.168.33.10:8080/configureTools/">Jenkins > Manage Jenkins > Global Tool
                        Configuration</a></li>
                    <li>Go to 'JDK'</li>
                    <li>Add JDK installation</li>
                    <li>Name: jdk8</li>
                    <li>JAVA_HOME: /usr/lib/jvm/java-8-oracle/</li>
                </ul>
                <aside class="notes">
                    We're going to build a java and maven project.
                </aside>
            </section>
            <section>
                <h2>Jenkins Global Tool Maven</h2>
                <ul>
                    <li><a href="http://192.168.33.10:8080/configureTools/">Jenkins > Manage Jenkins > Global Tool
                        Configuration</a></li>
                    <li>Go to 'Maven'</li>
                    <li>Add Maven installation</li>
                    <li>Name: M3</li>
                    <li>MAVEN_HOME: /usr/share/maven/maven-3.3.9/</li>
                </ul>
            </section>
        </section>
        <section>
            <section>
                <h1>Pipeline</h1>
            </section>
            <section>
                <h2>What is a pipeline?</h2>
                <img alt="A pipeline" src="pipeline.jpg" width="707" height="500"/>
                <aside class="notes">
                    <ul>
                        <li>Coined by Humble & Farley</li>
                        <li>What flows through a pipeline?</li>
                        <li>We'll implement part of this (show slide where parts are marked)</li>
                        <li>
                            <ul>
                                <li>Clone git repository (not shown in here)</li>
                                <li>Compile code</li>
                                <li>Feedback to user</li>
                                <li>Add License to code</li>
                                <li>Run tests</li>
                                <li>Version code (not shown here)</li>
                                <li>Create and push git tag (not shown here)</li>
                                <li>Manual steps (approval)</li>
                                <li>Deploy to a artifact repo</li>
                            </ul>
                        </li>
                        <li>Principles: build each artifact only once!</li>
                        <li>Versioning (semantic versioning). Every commit a version.</li>
                        <li>How to use credentials.</li>
                        <li>Manual steps.</li>
                    </ul>
                </aside>
            </section>
        </section>
        <section>
            <section>
                <h2>First Pipeline</h2>
                <ul>
                    <li><a href="http://192.168.33.10:8080/view/All/newJob">Jenkins > New Item</a></li>
                    <li>Item name: workshop</li>
                    <li>Select 'Pipeline' as project type.</li>
                    <li>Click 'OK'</li>
                    <li>Go to 'Pipeline' section in the configuration page.</li>
                </ul>
            </section>
            <section>
                <h2>Pipeline Script</h2>
                <pre>
                    <code class="groovy">
node {
   stage 'Checkout'

   git url: 'https://github.com/mgfeller/sample-spring-app.git'

   def mvnHome = tool 'M3'

   stage 'Build'

   sh "${mvnHome}/bin/mvn clean package -DskipTests"
}
                    </code>
                </pre>
                <p style="text-align: center">Click 'Save', then 'Build now'.</p>
            </section>
            <section>
                <img src="pipeline-first-build.jpg">
            </section>
        </section>
        <section>
            <section>
                <h2>Testing and Feedback</h2>
                <pre>
                    <code class="groovy">
   stage 'Unit Test'

   sh "${mvnHome}/bin/mvn test -DpipelineFailOneTest=true"

   stage 'Deploy'

   echo "Deployed!"
                    </code>
                </pre>
                <p style="text-align: center">Click 'Save', then 'Build now'.</p>
                <aside class="notes">
                    <ul>
                        <li>-DpipelineFailOneTest=true forces one test to fail</li>
                        <li>we add e-mail notification in a minute</li>
                    </ul>
                </aside>
            </section>
            <section>
                <h2>Archiving Test Results</h2>
                <pre>
                    <code class="groovy">
   stage 'Unit Test'
   try {
       sh "${mvnHome}/bin/mvn -B test -DpipelineFailOneTest=true"
   } catch (err) {
       step([$class: 'JUnitResultArchiver',
            testResults: '**/target/surefire-reports/TEST-*.xml'])
       throw err
   }
                    </code>
                </pre>
                <p style="text-align: center">Click 'Save', then 'Build now'.</p>
                <aside class="notes">
                    <li>
                        <a href="https://support.cloudbees.com/hc/en-us/articles/218866667-How-to-abort-a-Pipeline-build-if-JUnit-tests-fail">How
                            to abort a Pipeline build if JUnit tests fail</a></li>
                    <li>Test results are now available in the build page.</li>
                </aside>
            </section>
            <section>
                <h2>Send E-Mail Notification</h2>
                <pre>
                    <code class="groovy">
        step([$class: 'JUnitResultArchiver',
            testResults: '**/target/surefire-reports/TEST-*.xml'])
        mail subject: 'Build Failed - Failed Unit Tests.',
            body: 'The workshop build failed!',
            charset: 'utf-8',
            from: 'vagrant@localhost',
            mimeType: 'text/plain',
            to: 'vagrant@localhost'
        throw err
                    </code>
                </pre>
                <p style="text-align: center">Build, then ssh to the vagrant box and check your mail!</p>
            </section>
            <section>
                <h2>Get Last Author to E-Mail</h2>
                <pre>
                    <code class="groovy">
    sh "git --no-pager show -s --format='%an <%ae>' > lastAuthor.txt"
    lastAuthor = readFile('lastAuthor.txt').trim()
    echo "Last author: ${lastAuthor}"
                    </code>
                </pre>
                <p style="text-align: center">E-Mail server not set up to handle external email addresses.</p>
            </section>
        </section>
        <section>
            <section>
                <h2>Suggestion for further work</h2>
                <ul>
                    <li>Multi branch builds</li>
                    <li>Jenkinsfile</li>
                </ul>
            </section>
        </section>
        <section id="resources-acknowledgements">
            <h2>Resources and Acknowledgements</h2>
            <ul>
                <li><a href="http://ow.ly/UZIBE">John Willis (Docker Inc.) Presentations</a></li>
                <li><a href="http://vfarcic.github.io/ms-workshop/#/cover">Microservices Lifecycle Workshop by Viktor
                    Farcic</a></li>
            </ul>
        </section>

    </div>
</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>
    // More info https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
        history: true,

        // More info https://github.com/hakimel/reveal.js#dependencies
        dependencies: [
            {src: 'plugin/markdown/marked.js'},
            {src: 'plugin/markdown/markdown.js'},
            {src: 'plugin/notes/notes.js', async: true},
            {
                src: 'plugin/highlight/highlight.js', async: true, callback: function () {
                hljs.initHighlightingOnLoad();
            }
            }
        ]
    });
</script>
</body>
</html>
